name: üöÄ Deploy Microservice to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: secrets
    
    steps:
      # First, checkout the repository
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper git operations
          fetch-depth: 0
          # Use a Personal Access Token with repo permissions
          token: ${{ secrets.PAT_TOKEN }}

      # Then configure Git identity (now we're in a git directory)
      - name: üîß Configure Git identity
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # Deploy to VPS
      - name: üì¶ SSH Deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          password: ${{ secrets.VPS_SSH_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            ticketsystem_avro_DIR="/root/f4-microserices-vps-configuration/ticket-store/backend/ticketsystem-avro"
            echo "üìÅ Navigating to project directory..."
            cd "$ticketsystem_avro_DIR"
            export KEYCLOAK_USERNAME='${{ secrets.KEYCLOAK_USERNAME }}'
            export KEYCLOAK_PASSWORD='${{ secrets.KEYCLOAK_PASSWORD }}'
            mvn -v
            mvn -e -U -B clean package -Prun-openapi

      # ---- GIT: TRIGGER ----
      - name: üì§ Push code to GitHub (origin)
        run: |
          # Push current HEAD to desired branch. Adjust 'master' -> 'main' if needed.
          git push origin HEAD:master

      # ---- JitPack: TRIGGER & CHECK ----
      - name: üîî Trigger JitPack build (master-SNAPSHOT)
        run: |
          set -euo pipefail
          # Hitting build.log for a SNAPSHOT triggers a build if needed
          curl -sS --max-time 5 "https://jitpack.io/com/github/phungle2508/ticket-store-avro/master-SNAPSHOT/build.log" || true

      - name: üîé Wait for JitPack build to complete
        run: |
          set -euo pipefail
          
          echo "‚è≥ Waiting for master-SNAPSHOT build to complete..."
          
          MAX_ATTEMPTS=30  # Maximum wait time: 30 attempts * 10 seconds = 5 minutes
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üîç Attempt $ATTEMPT/$MAX_ATTEMPTS - Checking build status..."
            
            # Get the build status
            RESPONSE=$(curl -sS "https://jitpack.io/api/builds/com.github.phungle2508/ticket-store-avro")
            echo "JITPACK_RESPONSE: $RESPONSE" | sed -e 's/^/JITPACK_BUILDS: /'
            
            # Extract master-SNAPSHOT status
            STATUS=$(echo "$RESPONSE" | jq -r '."com.github.phungle2508"."ticket-store-avro"."master-SNAPSHOT" // "unknown"')
            echo "üìä master-SNAPSHOT status: $STATUS"
            
            # Check if build is complete (ok or Error)
            if [ "$STATUS" = "ok" ]; then
              echo "‚úÖ Build completed successfully!"
              exit 0
            elif [ "$STATUS" = "Error" ]; then
              echo "‚ùå Build failed with Error status!"
              exit 1
            elif [ "$STATUS" = "Building" ]; then
              echo "‚è≥ Still building... waiting 10 seconds"
              sleep 10
            elif [ "$STATUS" = "unknown" ] || [ "$STATUS" = "null" ]; then
              echo "‚ùì Build status unknown, waiting 10 seconds"
              sleep 10
            else
              echo "ü§î Unexpected status: $STATUS, waiting 10 seconds"
              sleep 10
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "‚è∞ Timeout reached after $MAX_ATTEMPTS attempts (5 minutes)"
          echo "üîç Final status check..."
          curl -sS "https://jitpack.io/api/builds/com.github.phungle2508/ticket-store-avro" | jq . | sed -e 's/^/FINAL_STATUS: /'
          exit 1

      - name: ‚úÖ Get latest successful build (latestOk)
        run: |
          set -euo pipefail
          curl -sS "https://jitpack.io/api/builds/com.github.phungle2508/ticket-store-avro/latestOk" | jq . | sed -e 's/^/JITPACK_LATEST_OK: /'