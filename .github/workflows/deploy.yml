name: ðŸš€ Deploy Microservice to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: secrets
    steps:
      - name: ðŸ“¦ SSH Deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          password: ${{ secrets.VPS_SSH_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            ticketsystem_avro_DIR="/root/f4-microserices-vps-configuration/ticket-store/backend/ticketsystem-avro"

            echo "ðŸ“ Navigating to project directory..."
            cd "$ticketsystem_avro_DIR"

            export KEYCLOAK_USERNAME='${{ secrets.KEYCLOAK_USERNAME }}'
            export KEYCLOAK_PASSWORD='${{ secrets.KEYCLOAK_PASSWORD }}'

            mvn -v
            mvn -e -U -B clean package -Prun-openapi
      - name: ðŸ”§ Configure Git identity
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      # ---- GIT: TRIGGER  ----
      - name: ðŸ“¤ Push code to GitHub (origin)
        run: |
          # Push current HEAD to desired branch. Adjust 'master' -> 'main' if needed.
          git push origin HEAD:master
      # ---- JitPack: TRIGGER & CHECK ----
      - name: ðŸ”” Trigger JitPack build (master-SNAPSHOT)
        run: |
          set -euo pipefail
          # Hitting build.log for a SNAPSHOT triggers a build if needed
          curl -sS --max-time 5 "https://jitpack.io/com/github/phungle2508/ticket-store-avro/master-SNAPSHOT/build.log" || true

      - name: ðŸ”Ž Check latest build info (any status)
        run: |
          set -euo pipefail
          curl -sS "https://jitpack.io/api/builds/com.github.phungle2508/ticket-store-avro" | jq . | sed -e 's/^/JITPACK_BUILDS: /'

      - name: âœ… Get latest successful build (latestOk)
        run: |
          set -euo pipefail
          curl -sS "https://jitpack.io/api/builds/com.github.phungle2508/ticket-store-avro/latestOk" | jq . | sed -e 's/^/JITPACK_LATEST_OK: /'
